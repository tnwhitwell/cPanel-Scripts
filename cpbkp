#!/bin/bash
DATE=$(date +%Y-%m-%d)

function usage {
  local problem=$1
  local me=$(basename "$0")
  echo "$problem" >&2
  echo "Usage: $me retentionUnit retention accountName..."
  echo "eg:"
  echo "  $me days 4 jeff steve"
  echo "Will create backups of jeff and steve, and remove backups older than 4 days"
  exit 1
}

if [ $# -lt 3 ]; then
  usage "Not enough arguments."
fi

retention_unit=$1
retention_time=$2
shift 2

if ! [[ "$retention_unit" =~ days|weeks|months ]]; then
  usage "Retention unit must be days / weeks / months"
fi

if [[ "$retention_time" =~ [^0-9]+ ]]; then
  usage "Retention value must be a number"
fi

for user in $@; do
  if [ ! -e "/var/cpanel/users/$user" ]; then
    usage "$user is not a valid user. Please check for mistypes :)"
  fi
done

if [ "$retention_unit" == "days" ]; then
  ret_thing="daily"
elif [ "$retention_unit" == "weeks" ]; then
  ret_thing="weekly"
else
  ret_thing="monthly"
fi

if [ ! -d "/backup/$ret_thing" ]; then
  mkdir "/backup/$ret_thing"
fi

DATE=$(date +%Y-%m-%d) # set the date :)

if [ ! -d "/backup/$ret_thing/$DATE" ]; then
  mkdir "/backup/$ret_thing/$DATE"
fi

for user in $@; do
  find "/backup/$ret_thing" -maxdepth 1 -mindepth 1 -type d | head -n -$retention_time | xargs rm -rfv 2>/dev/null
  /scripts/pkgacct --backup "$user" "/backup/$ret_thing/$DATE"
done
